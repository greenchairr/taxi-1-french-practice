<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Nouveau Taxi Practice</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-inner { transition: transform 0.6s; }
        /* Sticky accent bar for writing - offset to clear the sticky header */
        .sticky-bar { position: sticky; top: 5rem; z-index: 40; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0 0 0.75rem 0.75rem; }
        body { font-family: sans-serif; margin: 0; padding: 0; background: #f8fafc; }
        button { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm p-4">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div onclick="app.showLessonSelect()" class="font-bold text-xl text-blue-600 cursor-pointer select-none">
                <span class="bg-blue-600 text-white p-1 rounded">Taxi!</span> Practice
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-yellow-50 text-yellow-700 px-3 py-1 rounded-full text-sm font-bold border border-yellow-200">
                    <span id="score-display">Score: 0</span>
                </div>
                <button onclick="app.confirmReset()" class="text-gray-500 hover:text-red-500 font-bold" title="Reset">‚Üª</button>
                <button id="home-btn" onclick="app.showMenu()" class="hidden text-gray-500 font-bold">üè†</button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="app-container" class="max-w-4xl mx-auto px-4 py-6 flex-grow w-full">
        <div class="text-center mt-10 text-gray-500">Loading app...</div>
    </main>

    <!-- RESET POPUP -->
    <div id="reset-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center">
            <h3 class="text-lg font-bold mb-2">Reset Progress?</h3>
            <p class="text-gray-500 mb-6">This will delete your score. Are you sure?</p>
            <div class="flex gap-3 justify-center">
                <button onclick="app.closeModal()" class="px-4 py-2 bg-gray-100 rounded-lg">Cancel</button>
                <button onclick="app.executeReset()" class="px-4 py-2 bg-red-600 text-white rounded-lg">Reset</button>
            </div>
        </div>
    </div>

    <!-- DATA FILES -->
    <script src="data/lecon1.js"></script><script src="data/lecon2.js"></script><script src="data/lecon3.js"></script><script src="data/lecon4.js"></script>
    <script src="data/lecon5.js"></script><script src="data/lecon6.js"></script><script src="data/lecon7.js"></script><script src="data/lecon8.js"></script>
    <script src="data/lecon9.js"></script><script src="data/lecon10.js"></script><script src="data/lecon11.js"></script><script src="data/lecon12.js"></script>
    <script src="data/lecon13.js"></script><script src="data/lecon14.js"></script><script src="data/lecon15.js"></script><script src="data/lecon16.js"></script>
    <script src="data/lecon17.js"></script><script src="data/lecon18.js"></script><script src="data/lecon19.js"></script><script src="data/lecon20.js"></script>
    <script src="data/lecon21.js"></script><script src="data/lecon22.js"></script><script src="data/lecon23.js"></script><script src="data/lecon24.js"></script>
    <script src="data/lecon25.js"></script><script src="data/lecon26.js"></script><script src="data/lecon27.js"></script><script src="data/lecon28.js"></script>
    <script src="data/lecon29.js"></script><script src="data/lecon30.js"></script><script src="data/lecon31.js"></script><script src="data/lecon32.js"></script>
    <script src="data/lecon33.js"></script><script src="data/lecon34.js"></script><script src="data/lecon35.js"></script><script src="data/lecon36.js"></script>

    <script>
        // --- 1. SAFE DATA LOADING ---
        window.lessonsData = window.lessonsData || {};
        for (let i = 1; i <= 36; i++) {
            if (!window.lessonsData['lecon' + i]) {
                const unitNum = Math.ceil(i / 4);
                window.lessonsData['lecon' + i] = {
                    title: "Le√ßon " + i, description: "Loading data...", icon: "box",
                    flashcards: [], grammar: [], writing: [], reading: {title:"", text:"", questions:[]}
                };
            }
        }

        // --- 2. STORAGE LOGIC ---
        const STORAGE_KEY = 'nouveau_taxi_progress';

        // --- 3. MAIN APP OBJECT ---
        window.app = {
            state: {
                view: 'lesson-select',
                currentLessonId: null,
                score: 0,
                completedModules: [],
                mistakes: [],
                
                // Module States
                flashcardIndex: 0, isFlipped: false,
                
                // Grammar & Writing (All-at-once)
                grammarAnswers: {}, grammarSubmitted: false,
                writingAnswers: {}, writingSubmitted: false, lastFocusedInputId: null,
                
                // Reading (All-at-once)
                readingAnswers: {}, readingResult: null, readingSubmitted: false,
                
                // Single Question modes (Review / Boss)
                quizIndex: 0, quizFeedback: null,
                
                // Boss Battle
                bossBattleActive: false, bossQuestions: [], bossScore: 0
            },

            init() {
                this.loadProgress();
                this.render();
            },

            // --- UTILITIES ---
            loadProgress() {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.state.score = data.score || 0;
                        this.state.completedModules = data.completedModules || [];
                        this.state.mistakes = data.mistakes || [];
                        const el = document.getElementById('score-display');
                        if(el) el.innerText = `Score: ${this.state.score}`;
                    }
                } catch (e) { console.error("Load error", e); }
            },

            saveProgress() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        score: this.state.score,
                        completedModules: this.state.completedModules,
                        mistakes: this.state.mistakes
                    }));
                } catch (e) { console.error("Save error", e); }
            },

            updateScore(points) {
                this.state.score += points;
                const el = document.getElementById('score-display');
                if(el) el.innerText = `Score: ${this.state.score}`;
                this.saveProgress();
            },

            markComplete(key) {
                if (!this.state.completedModules.includes(key)) {
                    this.state.completedModules.push(key);
                    this.saveProgress();
                }
            },

            addMistake(type, lessonId, qIndex, questionData) {
                const exists = this.state.mistakes.find(m => m.lessonId === lessonId && m.qIndex === qIndex && m.type === type);
                if (!exists) {
                    this.state.mistakes.push({ type, lessonId, qIndex, data: questionData, timestamp: Date.now() });
                    this.saveProgress();
                }
            },

            removeMistake(type, lessonId, qIndex) {
                this.state.mistakes = this.state.mistakes.filter(m => !(m.lessonId === lessonId && m.qIndex === qIndex && m.type === type));
                this.saveProgress();
            },

            speak(text, event) {
                if(event) event.stopPropagation();
                if ('speechSynthesis' in window) {
                    // Check if speaking, if so, stop (cancel)
                    if (window.speechSynthesis.speaking) {
                        window.speechSynthesis.cancel();
                    } else {
                        // Not speaking, so start speaking
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'fr-FR';
                        utterance.rate = 0.9;
                        window.speechSynthesis.speak(utterance);
                    }
                } else {
                    alert("Audio not supported on this browser.");
                }
            },

            stopAudio() {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            },

            // --- NAVIGATION ---
            loadLesson(lessonId) {
                this.stopAudio();
                this.state.currentLessonId = lessonId;
                this.state.view = 'menu';
                this.render();
            },

            showLessonSelect() {
                this.stopAudio();
                this.state.view = 'lesson-select';
                this.state.currentLessonId = null;
                this.state.bossBattleActive = false;
                this.render();
            },

            showMenu() {
                this.stopAudio();
                this.state.view = 'menu';
                this.render();
            },

            startModule(mod) {
                this.stopAudio();
                const lesson = window.lessonsData[this.state.currentLessonId];
                
                // Initialize/Reset State based on Module
                if (mod === 'reading') {
                    this.state.readingAnswers = {};
                    this.state.readingResult = null;
                    this.state.readingSubmitted = false;
                    if (lesson?.reading?.questions) lesson.reading.questions.forEach(q => q.options?.sort(() => Math.random() - 0.5));
                } else if (mod === 'writing') {
                    this.state.writingAnswers = {};
                    this.state.writingSubmitted = false;
                    if(lesson?.writing) lesson.writing.sort(() => Math.random() - 0.5);
                } else if (mod === 'grammar') {
                    this.state.grammarAnswers = {};
                    this.state.grammarSubmitted = false;
                    if (lesson?.grammar) {
                        lesson.grammar.sort(() => Math.random() - 0.5);
                        lesson.grammar.forEach(q => q.options?.sort(() => Math.random() - 0.5));
                    }
                } else if (mod === 'flashcards') {
                    this.state.flashcardIndex = 0;
                    this.state.isFlipped = false;
                    if(lesson?.flashcards) lesson.flashcards.sort(() => Math.random() - 0.5);
                }
                
                this.state.view = mod;
                this.render();
                window.scrollTo(0, 0); 
                lucide.createIcons();
            },

            startReview() {
                this.stopAudio();
                if (this.state.mistakes.length === 0) return;
                this.state.view = 'review';
                this.state.quizIndex = 0;
                this.state.quizFeedback = null;
                this.render();
            },

            // --- BOSS BATTLE LOGIC ---
            checkUnitCompletion(unitIndex) { 
                const startLesson = (unitIndex * 4) + 1;
                const endLesson = startLesson + 3;
                let allDone = true;
                for(let i = startLesson; i <= endLesson; i++) {
                    const lid = 'lecon' + i;
                    if (!this.state.completedModules.includes(`${lid}-reading`) ||
                        !this.state.completedModules.includes(`${lid}-writing`) ||
                        !this.state.completedModules.includes(`${lid}-grammar`)) {
                        allDone = false;
                    }
                }
                return allDone;
            },

            startBossBattle(unitIndex) {
                this.stopAudio();
                const startLesson = (unitIndex * 4) + 1;
                const endLesson = startLesson + 3;
                let pool = [];
                for(let i = startLesson; i <= endLesson; i++) {
                    const l = window.lessonsData['lecon' + i];
                    if(l && l.grammar) pool = pool.concat(l.grammar.map(q => ({...q, origin: l.title})));
                }
                this.state.bossQuestions = pool.sort(() => Math.random() - 0.5).slice(0, 20);
                this.state.bossQuestions.forEach(q => { if(q.options) q.options = [...q.options].sort(() => Math.random() - 0.5); });
                this.state.quizIndex = 0;
                this.state.bossScore = 0;
                this.state.bossBattleActive = true;
                this.state.quizFeedback = null;
                this.state.view = 'boss-battle';
                this.render();
            },

            // --- RENDERERS ---
            render() {
                const container = document.getElementById('app-container');
                const homeBtn = document.getElementById('home-btn');
                
                const iconMap = {
                    'hand': 'üëã', 'user': 'üë§', 'smile': 'üòÉ', 'mail': 'üìß', 'search': 'üîç', 
                    'user-check': 'üïµÔ∏è', 'shopping-bag': 'üõçÔ∏è', 'palette': 'üé®', 'home': 'üè†', 
                    'map': 'üó∫Ô∏è', 'message-circle': 'üí¨', 'camera': 'üì∑', 'clock': '‚è∞', 
                    'calendar': 'üìÖ', 'dribbble': 'üèÄ', 'award': 'üèÜ', 'shopping-cart': 'üõí',
                    'utensils': 'üç¥', 'coffee': '‚òï', 'shirt': 'üëï', 'sun': '‚òÄÔ∏è', 'train': 'üöÜ',
                    'bed': 'üõèÔ∏è', 'ticket': 'üé´', 'history': 'üìú', 'plane-takeoff': 'üõ´',
                    'fast-forward': '‚è©', 'book-open': 'üìñ', 'pen-tool': '‚úçÔ∏è', 'brain': 'üß†', 'layers': 'üìá'
                };

                const safeIcon = (name) => {
                    if (iconMap[name]) return `<span class="text-2xl">${iconMap[name]}</span>`;
                    if (typeof lucide !== 'undefined' && lucide.icons[name]) return `<i data-lucide="${name}"></i>`;
                    return `<span class="text-xl">üìç</span>`;
                };

                try {
                    if (this.state.view === 'lesson-select') {
                        if(homeBtn) homeBtn.classList.add('hidden');
                        container.innerHTML = this.getLessonSelectHTML(safeIcon);
                    } else if (this.state.view === 'menu') {
                        if(homeBtn) homeBtn.classList.remove('hidden'); 
                        container.innerHTML = this.getMenuHTML(safeIcon);
                    } else if (this.state.view === 'review') {
                        homeBtn.classList.remove('hidden');
                        container.innerHTML = this.getReviewHTML(safeIcon);
                    } else if (this.state.view === 'boss-battle') {
                        homeBtn.classList.remove('hidden');
                        container.innerHTML = this.getBossBattleHTML(safeIcon);
                    } else {
                        if(homeBtn) homeBtn.classList.remove('hidden');
                        const lesson = window.lessonsData[this.state.currentLessonId];
                        
                        if (this.state.view === 'reading') container.innerHTML = this.getReadingHTML(lesson.reading, safeIcon);
                        else if (this.state.view === 'writing') container.innerHTML = this.getWritingHTML(lesson.writing, safeIcon);
                        else if (this.state.view === 'grammar') container.innerHTML = this.getGrammarHTML(lesson.grammar, safeIcon);
                        else if (this.state.view === 'flashcards') container.innerHTML = this.getFlashcardsHTML(lesson.flashcards, safeIcon);
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error("Render Error:", err);
                    container.innerHTML = `<div class="p-4 bg-red-100 text-red-700">Error: ${err.message}. Please refresh.</div>`;
                }
            },

            getLessonSelectHTML(iconFn) {
                let html = `
                    <div class="max-w-5xl mx-auto py-8 text-center fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <div><h1 class="text-3xl font-bold text-gray-900 mb-2">36 Le√ßons</h1><p class="text-gray-500">Le Nouveau Taxi! 1</p></div>
                            ${this.state.mistakes.length > 0 ? `<button onclick="app.startReview()" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200 transition flex items-center gap-2">‚ö†Ô∏è Review Mistakes (${this.state.mistakes.length})</button>` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;

                for(let i = 0; i < 36; i++) {
                    const lessonNum = i + 1;
                    const key = 'lecon' + lessonNum;
                    const lesson = window.lessonsData[key];
                    const unitIndex = Math.floor(i / 4); 
                    const colors = ['blue', 'emerald', 'orange', 'purple', 'pink', 'indigo', 'cyan', 'rose', 'amber'];
                    const color = colors[unitIndex % colors.length];

                    html += `
                        <button onclick="app.loadLesson('${key}')" class="bg-white p-4 rounded-xl shadow-sm border-2 border-${color}-100 hover:border-${color}-500 hover:shadow-md transition-all flex items-center gap-3 text-left group">
                            <div class="bg-${color}-50 p-3 rounded-full flex-shrink-0 group-hover:bg-${color}-100 text-2xl">
                                ${iconFn(lesson.icon || 'box')}
                            </div>
                            <div class="truncate w-full">
                                <h3 class="text-md font-bold text-gray-800 truncate">${lesson.title}</h3>
                                <p class="text-gray-400 text-xs truncate">${lesson.description}</p>
                            </div>
                        </button>
                    `;

                    if ((i + 1) % 4 === 0) {
                        const isUnlocked = this.checkUnitCompletion(unitIndex);
                        const unitNum = unitIndex + 1;
                        html += `
                            <div class="col-span-1 md:col-span-2 lg:col-span-3 py-4">
                                <button onclick="${isUnlocked ? `app.startBossBattle(${unitIndex})` : ''}" class="w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all ${isUnlocked ? `bg-gradient-to-r from-${color}-500 to-${color}-700 text-white shadow-lg hover:scale-[1.02]` : 'bg-gray-100 text-gray-400 cursor-not-allowed border-2 border-gray-200'}">
                                    ${isUnlocked ? '‚öîÔ∏è' : 'üîí'} UNIT ${unitNum} BOSS BATTLE
                                    ${!isUnlocked ? '<span class="text-xs font-normal ml-2 opacity-75">(Complete all lessons to unlock)</span>' : ''}
                                </button>
                            </div>
                        `;
                    }
                }
                html += `</div></div>`;
                return html;
            },

            getMenuHTML(iconFn) {
                const lesson = window.lessonsData[this.state.currentLessonId];
                const isDone = (mod) => this.state.completedModules.includes(`${this.state.currentLessonId}-${mod}`)
                    ? `<div class="absolute top-4 right-4 bg-white text-green-600 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1 shadow-sm">Done</div>` : '';

                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8 fade-in">
                        <div class="col-span-1 md:col-span-2 text-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">${lesson.title}</h2>
                            <p class="text-gray-500">${lesson.description}</p>
                        </div>
                        <button onclick="app.startModule('reading')" class="relative bg-emerald-500 text-white p-6 rounded-xl shadow-lg hover:translate-y-1 transition-all text-left flex flex-col gap-4">
                            ${isDone('reading')} <div class="bg-white/20 p-3 rounded-lg w-fit">${iconFn('book-open')}</div>
                            <div><h3 class="text-xl font-bold">Reading</h3></div>
                        </button>
                        <button onclick="app.startModule('writing')" class="relative bg-pink-500 text-white p-6 rounded-xl shadow-lg hover:translate-y-1 transition-all text-left flex flex-col gap-4">
                            ${isDone('writing')} <div class="bg-white/20 p-3 rounded-lg w-fit">${iconFn('pen-tool')}</div>
                            <div><h3 class="text-xl font-bold">Writing</h3></div>
                        </button>
                        <button onclick="app.startModule('grammar')" class="relative bg-purple-500 text-white p-6 rounded-xl shadow-lg hover:translate-y-1 transition-all text-left flex flex-col gap-4">
                            ${isDone('grammar')} <div class="bg-white/20 p-3 rounded-lg w-fit">${iconFn('brain')}</div>
                            <div><h3 class="text-xl font-bold">Grammar</h3></div>
                        </button>
                        <button onclick="app.startModule('flashcards')" class="relative bg-blue-500 text-white p-6 rounded-xl shadow-lg hover:translate-y-1 transition-all text-left flex flex-col gap-4">
                            <div class="bg-white/20 p-3 rounded-lg w-fit">${iconFn('layers')}</div>
                            <div><h3 class="text-xl font-bold">Flashcards</h3></div>
                        </button>
                    </div>
                `;
            },

            // --- GRAMMAR (ALL-AT-ONCE) ---
            selectGrammarAnswer(idx, opt) {
                if (this.state.grammarSubmitted) return;
                this.state.grammarAnswers[idx] = opt;
                // Update only this question's UI to avoid full redraw flicker
                const container = document.getElementById(`grammar-q-${idx}`);
                if (container) {
                    Array.from(container.querySelectorAll('button')).forEach(btn => {
                        const isSelected = btn.dataset.opt === opt;
                        btn.className = `w-full p-4 rounded-xl text-left border-2 transition-all flex justify-between items-center ${isSelected ? 'border-purple-500 bg-purple-50 text-purple-700 font-medium' : 'border-gray-100 hover:border-purple-200 hover:bg-purple-50'}`;
                    });
                }
            },

            submitGrammar() {
                if (this.state.grammarSubmitted) return;
                this.state.grammarSubmitted = true;
                const questions = window.lessonsData[this.state.currentLessonId].grammar;
                let correctCount = 0;
                
                questions.forEach((q, idx) => {
                    const ans = this.state.grammarAnswers[idx];
                    const isCorrect = ans === q.answer;
                    if (isCorrect) {
                        correctCount++;
                        // Smart Scoring: Track per question
                        const qKey = `${this.state.currentLessonId}-grammar-q${q.id}`;
                        if (!this.state.completedModules.includes(qKey)) {
                            this.updateScore(10);
                            this.markComplete(qKey);
                        }
                    } else {
                        this.addMistake('grammar', this.state.currentLessonId, q.id, q);
                    }
                });
                
                this.markComplete(this.state.currentLessonId + '-grammar');
                this.render();
                window.scrollTo(0,0);
            },

            getGrammarHTML(questions, iconFn) {
                const submitted = this.state.grammarSubmitted;
                
                let html = `<div class="max-w-2xl mx-auto py-8 fade-in">
                    <h2 class="text-2xl font-bold text-purple-800 flex items-center gap-2 mb-6">${iconFn('brain')} Grammar Quiz</h2>`;
                
                if (submitted) {
                    let score = 0;
                    questions.forEach((q, i) => { if(this.state.grammarAnswers[i] === q.answer) score++; });
                    html += `
                        <div class="bg-purple-100 text-purple-900 p-6 rounded-xl text-center mb-8 border-2 border-purple-200 shadow-md">
                            <h3 class="text-2xl font-bold mb-2">Score: ${score} / ${questions.length}</h3>
                            <button onclick="app.showMenu()" class="mt-2 px-6 py-2 bg-white text-purple-800 rounded-lg font-bold shadow-sm hover:bg-purple-50 border border-purple-200">Return to Menu</button>
                        </div>
                    `;
                }

                questions.forEach((q, idx) => {
                    const userAns = this.state.grammarAnswers[idx];
                    let feedback = '';
                    if (submitted) {
                        if (userAns === q.answer) feedback = `<div class="mt-3 text-green-600 font-bold flex items-center gap-2">‚úÖ Correct! <span class="text-gray-500 font-normal text-sm">${q.explanation}</span></div>`;
                        else feedback = `<div class="mt-3 text-red-600 font-bold flex items-center gap-2">‚ùå Incorrect. <span class="text-gray-600 font-normal text-sm">Answer: ${q.answer}. ${q.explanation}</span></div>`;
                    }

                    html += `
                        <div class="bg-white rounded-xl shadow p-6 mb-6">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">${idx + 1}. ${q.question}</h3>
                            <div class="space-y-3" id="grammar-q-${idx}">
                                ${q.options.map(opt => {
                                    const safeOpt = opt.replace(/"/g, '&quot;');
                                    let btnClass = "w-full p-4 rounded-xl text-left border-2 transition-all flex justify-between items-center ";
                                    
                                    if (submitted) {
                                        if (opt === q.answer) btnClass += "border-green-500 bg-green-50 text-green-700 font-bold";
                                        else if (opt === userAns) btnClass += "border-red-500 bg-red-50 text-red-700 line-through";
                                        else btnClass += "border-gray-100 opacity-50";
                                    } else {
                                        if (userAns === opt) btnClass += "border-purple-500 bg-purple-50 text-purple-700 font-medium";
                                        else btnClass += "border-gray-100 hover:border-purple-200 hover:bg-purple-50";
                                    }

                                    return `<button onclick="app.selectGrammarAnswer(${idx}, '${safeOpt}')" ${submitted ? 'disabled' : ''} data-opt="${safeOpt}" class="${btnClass}">
                                        ${opt}
                                        ${submitted && opt === q.answer ? '‚úÖ' : ''}
                                        ${submitted && opt === userAns && opt !== q.answer ? '‚ùå' : ''}
                                    </button>`;
                                }).join('')}
                            </div>
                            ${feedback}
                        </div>
                    `;
                });

                if (!submitted) {
                    html += `<button onclick="app.submitGrammar()" class="w-full py-4 bg-purple-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-purple-700 transition-transform transform hover:-translate-y-1">Submit Answers</button>`;
                }

                html += `</div>`;
                return html;
            },

            // --- WRITING (ALL-AT-ONCE) ---
            typeChar(char) {
                if (this.state.lastFocusedInputId) {
                    const input = document.getElementById(this.state.lastFocusedInputId);
                    if (input) {
                        const start = input.selectionStart;
                        const end = input.selectionEnd;
                        const text = input.value;
                        input.value = text.substring(0, start) + char + text.substring(end);
                        input.selectionStart = input.selectionEnd = start + 1;
                        input.focus();
                        const idx = parseInt(this.state.lastFocusedInputId.split('-')[2]);
                        app.updateWritingAnswer(idx, input.value);
                    }
                }
            },

            trackFocus(id) {
                this.state.lastFocusedInputId = id;
            },

            updateWritingAnswer(idx, val) {
                this.state.writingAnswers[idx] = val;
            },

            submitWriting() {
                if (this.state.writingSubmitted) return;
                this.state.writingSubmitted = true;
                const challenges = window.lessonsData[this.state.currentLessonId].writing;
                let correctCount = 0;

                challenges.forEach((q, idx) => {
                    const userVal = this.state.writingAnswers[idx] || "";
                    const normalized = userVal.trim().toLowerCase().replace(/[.,!?-]/g, '');
                    const answers = q.french.map(a => a.toLowerCase().replace(/[.,!?-]/g, ''));
                    
                    if (answers.includes(normalized)) {
                        correctCount++;
                        const qKey = `${this.state.currentLessonId}-writing-q${idx}`; 
                        if (!this.state.completedModules.includes(qKey)) {
                            this.updateScore(20);
                            this.markComplete(qKey);
                        }
                    } else {
                        this.addMistake('writing', this.state.currentLessonId, idx, q);
                    }
                });

                this.markComplete(this.state.currentLessonId + '-writing');
                this.render();
                window.scrollTo(0,0);
            },

            getWritingHTML(challenges, iconFn) {
                const submitted = this.state.writingSubmitted;
                
                let html = `
                    <div class="max-w-2xl mx-auto py-8 fade-in relative">
                        <div class="sticky-bar py-2 mb-4 border-b border-gray-100 flex gap-2 justify-center shadow-sm rounded-b-xl">
                            ${['√©','√®','√†','√ß','√¥','√™','√Æ','√ª'].map(c => `<button onclick="app.typeChar('${c}')" class="bg-gray-100 px-4 py-2 rounded-lg font-bold text-lg hover:bg-gray-200 transition">${c}</button>`).join('')}
                        </div>
                        <h2 class="text-2xl font-bold text-pink-800 flex items-center gap-2 mb-6">${iconFn('pen-tool')} Writing Challenge</h2>`;

                if (submitted) {
                    let score = 0;
                    challenges.forEach((q, i) => {
                        const val = this.state.writingAnswers[i] || "";
                        const norm = val.trim().toLowerCase().replace(/[.,!?-]/g, '');
                        if (q.french.map(a=>a.toLowerCase().replace(/[.,!?-]/g, '')).includes(norm)) score++;
                    });
                    html += `
                        <div class="bg-pink-100 text-pink-900 p-6 rounded-xl text-center mb-8 border-2 border-pink-200 shadow-md">
                            <h3 class="text-2xl font-bold mb-2">Score: ${score} / ${challenges.length}</h3>
                            <button onclick="app.showMenu()" class="mt-2 px-6 py-2 bg-white text-pink-800 rounded-lg font-bold shadow-sm hover:bg-pink-50 border border-pink-200">Return to Menu</button>
                        </div>
                    `;
                }

                challenges.forEach((q, idx) => {
                    const userVal = this.state.writingAnswers[idx] || "";
                    let feedback = '';
                    let inputClass = "w-full p-4 border-2 rounded-xl text-lg outline-none transition-colors ";
                    
                    if (submitted) {
                        const norm = userVal.trim().toLowerCase().replace(/[.,!?-]/g, '');
                        const isCorrect = q.french.map(a=>a.toLowerCase().replace(/[.,!?-]/g, '')).includes(norm);
                        
                        if (isCorrect) {
                            inputClass += "border-green-500 bg-green-50 text-green-800";
                            feedback = `<div class="mt-2 text-green-600 font-bold">‚úÖ Correct!</div>`;
                        } else {
                            inputClass += "border-red-500 bg-red-50 text-red-800";
                            feedback = `<div class="mt-2 text-red-600">‚ùå Correct answer: <b>${q.french[0]}</b></div>`;
                        }
                    } else {
                        inputClass += "border-gray-200 focus:border-pink-500 focus:ring-2 focus:ring-pink-200";
                    }

                    html += `
                        <div class="bg-white rounded-xl shadow p-6 mb-6">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-sm font-bold text-pink-500 uppercase tracking-wide">Challenge ${idx + 1}</span>
                                <span class="text-xs text-gray-400 italic">Hint: ${q.hint}</span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">"${q.english}"</h3>
                            <textarea 
                                id="writing-q-${idx}"
                                ${submitted ? 'disabled' : ''}
                                onfocus="app.trackFocus('writing-q-${idx}')"
                                oninput="app.updateWritingAnswer(${idx}, this.value)"
                                class="${inputClass}"
                                rows="2"
                                placeholder="Type in French..."
                            >${userVal}</textarea>
                            ${feedback}
                        </div>
                    `;
                });

                if (!submitted) {
                    html += `<button onclick="app.submitWriting()" class="w-full py-4 bg-pink-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-pink-700 transition-transform transform hover:-translate-y-1">Submit Answers</button>`;
                }

                html += `</div>`;
                return html;
            },

            // --- FLASHCARDS & READING (DOM Updates for smooth flip/click) ---
            getFlashcardsHTML(cards, iconFn) {
                const card = cards[this.state.flashcardIndex];
                if (!card) return '<div>No Flashcards available.</div>';
                return `
                    <div class="flex flex-col items-center justify-center max-w-md mx-auto h-full py-8 fade-in">
                        <div class="flex justify-between w-full items-center mb-6">
                            <h2 class="text-2xl font-bold text-blue-800 flex items-center gap-2">üìá Flashcards</h2>
                            <button onclick="app.speak('${card.back.replace(/'/g, "\\'")}')" class="bg-blue-100 text-blue-600 p-2 rounded-full hover:bg-blue-200">üîä</button>
                        </div>
                        <div onclick="app.toggleFlip()" class="relative w-full h-64 cursor-pointer perspective-1000 group">
                            <div id="flashcard-inner" class="relative w-full h-full duration-500 transform-style-3d card-inner ${this.state.isFlipped ? 'rotate-y-180' : ''}">
                                <div class="absolute w-full h-full bg-white border-2 border-blue-100 rounded-2xl shadow-xl flex items-center justify-center p-8 backface-hidden">
                                    <div class="text-center"><div class="text-8xl mb-4">${card.icon}</div><p class="text-gray-400 text-sm">(Click to flip)</p></div>
                                </div>
                                <div class="absolute w-full h-full bg-blue-600 rounded-2xl shadow-xl flex items-center justify-center p-8 rotate-y-180 backface-hidden">
                                    <div class="text-center text-white"><h3 class="text-3xl font-bold mb-2">${card.back}</h3><p class="text-blue-200 text-lg">${card.english}</p></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-6 mt-8">
                            <button onclick="app.prevCard()" class="p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600">‚¨ÖÔ∏è</button>
                            <span class="font-mono text-gray-500">${this.state.flashcardIndex + 1} / ${cards.length}</span>
                            <button onclick="app.nextCard()" class="p-3 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-600">‚û°Ô∏è</button>
                        </div>
                    </div>
                `;
            },
            toggleFlip() { 
                this.state.isFlipped = !this.state.isFlipped;
                const el = document.getElementById('flashcard-inner');
                if(el) {
                    if(this.state.isFlipped) el.classList.add('rotate-y-180');
                    else el.classList.remove('rotate-y-180');
                }
            },
            nextCard() { const deck = window.lessonsData[this.state.currentLessonId].flashcards; this.state.flashcardIndex = (this.state.flashcardIndex + 1) % deck.length; this.state.isFlipped = false; this.render(); },
            prevCard() { const deck = window.lessonsData[this.state.currentLessonId].flashcards; this.state.flashcardIndex = (this.state.flashcardIndex - 1 + deck.length) % deck.length; this.state.isFlipped = false; this.render(); },

            // --- SINGLE QUESTION MODES (Review / Boss) ---
            getBossBattleHTML(iconFn) {
                if (this.state.bossScore === undefined) this.state.bossScore = 0; 
                if (this.state.quizIndex >= this.state.bossQuestions.length) {
                    const pass = this.state.bossScore >= 16;
                    return `
                        <div class="max-w-xl mx-auto py-8 text-center fade-in">
                            <h2 class="text-3xl font-bold ${pass ? 'text-yellow-600' : 'text-gray-700'} mb-6">${pass ? 'üèÜ VICTORY!' : 'Try Again'}</h2>
                            <div class="${pass ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200'} border-2 rounded-2xl shadow-lg p-8">
                                <div class="text-6xl mb-4">${pass ? 'üëë' : 'üí™'}</div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-4">Score: ${this.state.bossScore} / 20</h3>
                                <button onclick="app.showLessonSelect()" class="px-8 py-3 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-900 transition-colors">Return to Map</button>
                            </div>
                        </div>
                    `;
                }
                const q = this.state.bossQuestions[this.state.quizIndex];
                return this.getGenericQuizHTML(q, this.state.quizIndex, this.state.bossQuestions.length, 'Boss Battle', (opt) => {
                    const isCorrect = opt === q.answer;
                    this.state.quizFeedback = { option: opt, isCorrect };
                    if (isCorrect) this.state.bossScore++;
                    this.render(); 
                    setTimeout(() => { this.state.quizIndex++; this.state.quizFeedback = null; this.render(); }, 1500);
                });
            },

            getReviewHTML(iconFn) {
                if (this.state.mistakes.length === 0) { this.showLessonSelect(); return; }
                const index = (this.state.quizIndex % this.state.mistakes.length + this.state.mistakes.length) % this.state.mistakes.length;
                const mistake = this.state.mistakes[index];
                
                if (mistake.type === 'writing') return this.getWritingReviewHTML(mistake.data, index, this.state.mistakes.length);

                let questionData = mistake.data;
                if (mistake.type === 'reading') {
                    const lesson = window.lessonsData[mistake.lessonId];
                    if (lesson && lesson.reading) {
                        questionData = { ...mistake.data, context: lesson.reading.text, contextTitle: lesson.reading.title };
                    }
                }

                return this.getGenericQuizHTML(questionData, index, this.state.mistakes.length, 'Review', (opt) => {
                    const isCorrect = opt === mistake.data.answer;
                    this.state.quizFeedback = { option: opt, isCorrect };
                    this.render(); 
                    if (isCorrect) {
                        setTimeout(() => {
                            this.removeMistake(mistake.type, mistake.lessonId, mistake.qIndex);
                            if (this.state.mistakes.length === 0) { alert("All clear!"); this.showLessonSelect(); } else { this.state.quizFeedback = null; this.render(); }
                        }, 1000);
                    } else { setTimeout(() => { this.state.quizIndex++; this.state.quizFeedback = null; this.render(); }, 1500); }
                }, true);
            },

            getWritingReviewHTML(q, index, total) {
                const fb = this.state.quizFeedback; // reusing generic feedback state
                return `
                    <div class="max-w-xl mx-auto py-8 fade-in">
                        <div class="sticky-bar py-2 mb-4 border-b border-gray-100 flex gap-2 justify-center shadow-sm rounded-b-xl">
                            ${['√©','√®','√†','√ß','√¥','√™'].map(c => `<button onclick="app.typeReviewChar('${c}')" class="bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">${c}</button>`).join('')}
                        </div>
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-indigo-800 flex items-center gap-2">‚ö†Ô∏è Review</h2>
                            <span class="text-sm font-mono bg-indigo-100 text-indigo-700 px-2 py-1 rounded">${index + 1} / ${total}</span>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">"${q.english}"</h3>
                            <p class="text-sm text-pink-500 italic mb-6">Hint: ${q.hint}</p>
                            
                            ${!fb ? `
                                <textarea id="review-input" onfocus="app.trackFocus('review-input')" class="w-full p-4 border-2 border-gray-200 rounded-xl mb-4"></textarea>
                                <button onclick="app.checkReviewWriting()" class="w-full py-3 bg-pink-600 text-white rounded-xl font-bold hover:bg-pink-700">Check</button>
                            ` : `
                                <div class="p-4 rounded-xl ${fb.isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-50 text-red-800'} mb-4">
                                    ${fb.isCorrect ? 'Correct!' : `Correct answer: <b>${fb.correctAnswer}</b>`}
                                </div>
                            `}

                            <div class="flex justify-between mt-6 pt-4 border-t border-gray-100">
                                <button onclick="app.prevReview()" class="px-4 py-2 text-gray-500 hover:text-indigo-600 font-bold flex items-center gap-2">‚¨ÖÔ∏è Prev</button>
                                <button onclick="app.nextReview()" class="px-4 py-2 text-gray-500 hover:text-indigo-600 font-bold flex items-center gap-2">Next ‚û°Ô∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            },

            typeReviewChar(char) {
                const input = document.getElementById('review-input');
                if(input) { 
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    const text = input.value;
                    input.value = text.substring(0, start) + char + text.substring(end);
                    input.selectionStart = input.selectionEnd = start + 1;
                    input.focus();
                }
            },

            checkReviewWriting() {
                const index = (this.state.quizIndex % this.state.mistakes.length + this.state.mistakes.length) % this.state.mistakes.length;
                const mistake = this.state.mistakes[index];
                const input = document.getElementById('review-input').value;
                const normalized = input.trim().toLowerCase().replace(/[.,!?-]/g, '');
                const answers = mistake.data.french.map(a => a.toLowerCase().replace(/[.,!?-]/g, ''));
                
                const isCorrect = answers.includes(normalized);
                this.state.quizFeedback = { isCorrect, correctAnswer: mistake.data.french[0] };
                this.render();

                if (isCorrect) {
                    setTimeout(() => {
                        this.removeMistake(mistake.type, mistake.lessonId, mistake.qIndex);
                        if (this.state.mistakes.length === 0) { alert("All clear!"); this.showLessonSelect(); } 
                        else { this.state.quizFeedback = null; this.render(); }
                    }, 1500);
                }
            },

            getGenericQuizHTML(q, index, total, title, callbackStr, showNav = false) {
                this.currentQuizCallback = callbackStr;
                return `
                    <div class="max-w-xl mx-auto py-8 fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-indigo-800 flex items-center gap-2">‚öîÔ∏è ${title}</h2>
                            <span class="text-sm font-mono bg-indigo-100 text-indigo-700 px-2 py-1 rounded">${index + 1} / ${total}</span>
                        </div>
                        
                        ${q.context ? `
                            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border-l-4 border-emerald-500">
                                <h4 class="font-bold text-gray-700 mb-2">${q.contextTitle || 'Text'}</h4>
                                <p class="text-sm text-gray-600 leading-relaxed font-serif">${q.context.replace(/\n/g, '<br>')}</p>
                            </div>
                        ` : ''}

                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            <h3 class="text-xl font-medium text-gray-800 mb-8">${q.question}</h3>
                            <div class="space-y-3">
                                ${q.options ? q.options.map(opt => {
                                    const safeOpt = opt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    let btnClass = "w-full p-4 rounded-xl text-left transition-all border-2 flex justify-between items-center ";
                                    if (this.state.quizFeedback) {
                                        if (opt === q.answer) btnClass += "border-green-500 bg-green-50 text-green-700";
                                        else if (opt === this.state.quizFeedback.option) btnClass += "border-red-500 bg-red-50 text-red-700";
                                        else btnClass += "border-gray-100 opacity-50";
                                    } else { btnClass += "border-gray-100 hover:border-indigo-200 hover:bg-indigo-50"; }
                                    return `<button onclick="app.currentQuizCallback('${safeOpt}')" class="${btnClass}"><span class="font-medium">${opt}</span>${this.state.quizFeedback && opt === q.answer ? '‚úÖ' : ''}</button>`;
                                }).join('') : '<p class="text-red-500">Error: Options missing</p>'}
                            </div>
                            ${this.state.quizFeedback ? `<div class="mt-6 p-4 bg-blue-50 text-blue-800 rounded-xl"><p>Explanation: ${q.explanation || "Correct!"}</p></div>` : ''}
                            
                            ${showNav ? `
                                <div class="flex justify-between mt-6 pt-4 border-t border-gray-100">
                                    <button onclick="app.prevReview()" class="px-4 py-2 text-gray-500 hover:text-indigo-600 font-bold flex items-center gap-2">‚¨ÖÔ∏è Prev</button>
                                    <button onclick="app.nextReview()" class="px-4 py-2 text-gray-500 hover:text-indigo-600 font-bold flex items-center gap-2">Next ‚û°Ô∏è</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            // Flashcards
            getFlashcardsHTML(cards, iconFn) {
                const card = cards[this.state.flashcardIndex];
                if (!card) return '<div>No Flashcards available.</div>';
                return `
                    <div class="flex flex-col items-center justify-center max-w-md mx-auto h-full py-8 fade-in">
                        <div class="flex justify-between w-full items-center mb-6">
                            <h2 class="text-2xl font-bold text-blue-800 flex items-center gap-2">üìá Flashcards</h2>
                            <button onclick="app.speak('${card.back.replace(/'/g, "\\'")}')" class="bg-blue-100 text-blue-600 p-2 rounded-full hover:bg-blue-200">üîä</button>
                        </div>
                        <div onclick="app.toggleFlip()" class="relative w-full h-64 cursor-pointer perspective-1000 group">
                            <div id="flashcard-inner" class="relative w-full h-full duration-500 transform-style-3d card-inner ${this.state.isFlipped ? 'rotate-y-180' : ''}">
                                <div class="absolute w-full h-full bg-white border-2 border-blue-100 rounded-2xl shadow-xl flex items-center justify-center p-8 backface-hidden">
                                    <div class="text-center"><div class="text-8xl mb-4">${card.icon}</div><p class="text-gray-400 text-sm">(Click to flip)</p></div>
                                </div>
                                <div class="absolute w-full h-full bg-blue-600 rounded-2xl shadow-xl flex items-center justify-center p-8 rotate-y-180 backface-hidden">
                                    <div class="text-center text-white"><h3 class="text-3xl font-bold mb-2">${card.back}</h3><p class="text-blue-200 text-lg">${card.english}</p></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-6 mt-8">
                            <button onclick="app.prevCard()" class="p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600">‚¨ÖÔ∏è</button>
                            <span class="font-mono text-gray-500">${this.state.flashcardIndex + 1} / ${cards.length}</span>
                            <button onclick="app.nextCard()" class="p-3 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-600">‚û°Ô∏è</button>
                        </div>
                    </div>
                `;
            },
            toggleFlip() { 
                this.state.isFlipped = !this.state.isFlipped;
                const el = document.getElementById('flashcard-inner');
                if(el) {
                    if(this.state.isFlipped) el.classList.add('rotate-y-180');
                    else el.classList.remove('rotate-y-180');
                }
            },
            nextCard() { const deck = window.lessonsData[this.state.currentLessonId].flashcards; this.state.flashcardIndex = (this.state.flashcardIndex + 1) % deck.length; this.state.isFlipped = false; this.render(); },
            prevCard() { const deck = window.lessonsData[this.state.currentLessonId].flashcards; this.state.flashcardIndex = (this.state.flashcardIndex - 1 + deck.length) % deck.length; this.state.isFlipped = false; this.render(); },

            // Reading
            selectReadingAnswer(idx, opt) { 
                this.state.readingAnswers[idx] = opt; 
                // Manual DOM update to avoid full re-render
                const container = document.getElementById(`q-options-${idx}`);
                if (container) {
                    Array.from(container.children).forEach(btn => {
                        const isSelected = btn.dataset.opt === opt;
                        // STRONG VISUAL FEEDBACK
                        btn.className = isSelected 
                            ? "w-full text-left p-3 rounded-lg border bg-emerald-100 border-emerald-600 ring-2 ring-emerald-500 font-medium transition-all"
                            : "w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors opacity-80";
                    });
                }
            },
            submitReading() {
                this.state.readingSubmitted = true;
                let correctCount = 0;
                const questions = window.lessonsData[this.state.currentLessonId].reading.questions;
                questions.forEach((q, idx) => {
                    if (this.state.readingAnswers[idx] === q.answer) correctCount++;
                    else this.addMistake('reading', this.state.currentLessonId, idx, q);
                });
                if (!this.state.completedModules.includes(this.state.currentLessonId+'-reading')) {
                    this.updateScore(correctCount * 15);
                    this.markComplete(this.state.currentLessonId+'-reading');
                }
                this.state.readingResult = correctCount;
                this.render();
                window.scrollTo(0,0);
            },
            getReadingHTML(readingData, iconFn) {
                const questions = readingData.questions;
                const submitted = this.state.readingSubmitted;
                let html = `<div class="max-w-2xl mx-auto py-8 fade-in">`;
                if (submitted) { html += `<div class="bg-emerald-100 text-emerald-900 p-6 rounded-xl text-center mb-8"><h3 class="text-2xl font-bold">Result: ${this.state.readingResult}/${questions.length}</h3><button onclick="app.showMenu()" class="mt-4 px-6 py-2 bg-white rounded-lg font-bold shadow-sm">Menu</button></div>`; }
                html += `<div class="bg-white rounded-2xl shadow-lg p-8 mb-6"><h3 class="text-xl font-bold mb-4 flex justify-between items-center">${readingData.title} <button onclick="app.speak('${readingData.text.replace(/'/g, "\\'").replace(/\n/g, " ")}')" class="bg-emerald-100 text-emerald-600 p-2 rounded-full">üîä</button></h3><p class="text-lg leading-relaxed text-gray-700 font-serif">${readingData.text.replace(/\n/g, '<br>')}</p></div>`;
                questions.forEach((q, idx) => {
                    html += `<div class="bg-white rounded-xl shadow p-6 mb-4"><p class="font-medium mb-4">${idx+1}. ${q.question}</p><div class="space-y-2" id="q-options-${idx}">`;
                    q.options.forEach(opt => {
                        const isSel = this.state.readingAnswers[idx] === opt;
                        let cls = "w-full text-left p-3 rounded-lg border transition-colors ";
                        if (!submitted) cls += isSel ? "bg-emerald-100 border-emerald-600 ring-2 ring-emerald-500 font-medium" : "border-gray-200 hover:bg-gray-50 opacity-80";
                        else {
                            if (opt === q.answer) cls += "bg-green-100 border-green-500 font-bold";
                            else if (isSel) cls += "bg-red-100 border-red-500 line-through";
                            else cls += "opacity-50";
                        }
                        const safeOpt = opt.replace(/"/g, '&quot;');
                        html += `<button data-opt="${safeOpt}" onclick="app.selectReadingAnswer(${idx}, this.dataset.opt)" ${submitted?'disabled':''} class="${cls}">${opt}</button>`;
                    });
                    html += `</div></div>`;
                });
                if(!submitted) html += `<button onclick="app.submitReading()" class="w-full mt-6 py-3 bg-emerald-600 text-white rounded-xl font-bold">Submit Answers</button>`;
                html += `</div>`;
                return html;
            },

            // NAVIGATION
            prevReview() {
                this.state.quizIndex--;
                if (this.state.quizIndex < 0) this.state.quizIndex = this.state.mistakes.length - 1;
                this.state.quizFeedback = null;
                this.state.writingFeedback = null;
                this.render();
            },
            nextReview() {
                this.state.quizIndex++;
                this.state.quizFeedback = null;
                this.state.writingFeedback = null;
                this.render();
            },

            confirmReset() { document.getElementById('reset-modal').classList.remove('hidden'); },
            closeModal() { document.getElementById('reset-modal').classList.add('hidden'); },
            executeReset() {
                this.state.score = 0;
                this.state.completedModules = [];
                this.state.mistakes = [];
                this.saveProgress();
                this.updateScore(0);
                this.closeModal();
                this.showLessonSelect();
            }
        };

        // Start App
        app.init();
    </script>
</body>
</html>
